const d3 = require("d3"),
      fs = require("fs");

console.log("load cbrQbnSuburbs.geojson ...");
fs.readFile("cbrQbnSuburbs.geojson", "utf8", function(error, data) {
  if (error) throw error;
  geoData = JSON
    .parse(data);

  console.log("load suburb_data.csv ...");
  fs.readFile("suburb_data.csv", "utf8", function(error, data) {
    if (error) throw error;
    censusData = d3
      .csvParse(data);

    censusData.forEach(function(d) {
        for (key in d) {
          if (key !== "suburb") d[key] = +d[key];
        }
      });

    console.log("matching census data to geodata ...");
    covidData = [];
    censusData.forEach(function(d) {
      let shape = geoData
        .features
        .filter(function(e) {
          return e.properties.name == d.suburb;
        })[0];
      shape.properties = d;
      covidData.push(shape);
    });

    covidData = {
      type: "FeatureCollection",
      features: covidData
    };

    fs.writeFile("actCovid.geojson", JSON.stringify(covidData), function(error) {
      console.log("actCovid.geojson written");
    })
  });
});
